<!DOCTYPE html>
<html lang="en">
<head>
    <title>DigitalMeter - Custom</title>
    <link rel="icon" href="favicon.ico">
    <link rel="stylesheet" href="common.css">
</head>
<body>

<div>
    <!-- prevent form submission-->
    <form id="form" onsubmit="return false;">
        <table>
            <tr>
                <td><label for="start">Start</label></td>
                <td><input type="datetime-local" id="start" required="required"> <br></td>
            </tr>
            <tr>
                <td><label for="end">End</label></td>
                <td><input type="datetime-local" id="end" required="required"> <br></td>
            </tr>
            <tr>
                <td><label for="resolution">Resolution (s)</label></td>
                <td><input type="number" id="resolution" required="required"></td>
            </tr>
        </table>
    </form>

    <button onclick="preview()">Preview</button>
    <button onclick="download()">Download</button>

    <div id="plot"></div>
</div>

<script src="common.js"></script>
<script>
    let form = document.getElementById("form")
    let input_start = document.getElementById("start")
    let input_end = document.getElementById("end")
    let input_resolution = document.getElementById("resolution")

    // set reasonable initial values: last day, one sample per minute
    let tz_offset_ms = (new Date()).getTimezoneOffset() * (60 * 1000)
    input_start.value = (new Date(Date.now() - tz_offset_ms - 24 * 3600 * 1000)).toISOString().slice(0, -8)
    input_end.value = (new Date(Date.now() - tz_offset_ms)).toISOString().slice(0, -8)
    input_resolution.value = 60

    function preview() {
        let url = download_url_for_inputs("json")
        if (url === undefined) return

        window
            .fetch(url)
            .then((response) => response.json())
            .then((data) => {
                console.log("Fetch result:", data)
            })
    }

    function download() {
        let url = download_url_for_inputs("csv")
        if (url === undefined) return

        // from https://stackoverflow.com/a/49917066/5517612
        const a = document.createElement("a")
        a.href = url;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function download_url_for_inputs(type) {
        if (!form.reportValidity()) {
            return undefined;
        }
        let start = (input_start.valueAsDate.getTime() + tz_offset_ms) / 1000.
        let end = (input_end.valueAsDate.getTime() + tz_offset_ms) / 1000.

        let params = new URLSearchParams({
            "bucket_size": input_resolution.value,
            "oldest": start,
            "newest": end,
        })

        return "../download/samples_custom." + type + "?" + params
    }
</script>

</body>
</html>